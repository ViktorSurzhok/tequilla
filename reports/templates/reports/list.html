{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}Отчеты{% endblock %}

{% block additional_css %}
    <style type="text/css">
        .address {
            font-style: italic;
        }

        .report-user-name {
            color: #FFAEAE;
        }

        .close_drinks_not_save {
            margin-bottom: 0;
        }
    </style>
{% endblock %}

{% block additional_js %}
    <script type="text/javascript" src="{% static 'js/jquery.timepicker.min.js' %}"></script>

    <script type="text/javascript">
        $(function() {
            var timepicker_options = {
                'timeFormat': 'H:i',
                'step': 15
            };
            $('.timepicker-input').timepicker(timepicker_options);


            function getNewContent() {
                // сбор данных фильтров
                var employee = $('#filter-employee').val(),
                    club = $('#filter-club').val(),
                    type = $('#filter-type').val();
                var filters = '?work_shift__employee=' + employee + '&work_shift__club=' + club +
                        '&start_week={{ start_week|date:"Y-m-d" }}&end_week={{ end_week|date:"Y-m-d" }}';
                if (type != '-1') {
                    filters += '&filled_date__isnull=' + type;
                }
                // запрос нового контента
                $.ajax({
                    url: '{{ filter_reports_link }}' + filters,
                    type: 'GET',
                    dataType: 'jsonp',
                    crossDomain: true,
                    success: function (data) {
                        $('#reports-container').html(data['reports']);
                    }
                });
            }

            // выбор недели по дате
            $('#calendar').daterangepicker(calendar_options);
            $('#calendar').on('apply.daterangepicker', function(e, picker) {
                var date = picker.startDate.format('YYYY-MM-DD');
                location = '{% url 'reports:reports_by_week' %}?start_date=' + date;
            });

            // нажатие кнопки сохранения комментария для отчета
            $('.add-comment-button').on('click', function(e) {
                e.preventDefault();
                var id = $(this).data('report-id');
                var data = {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    id: id,
                    comment: $('#comment_' + id).find('textarea').val()
                };
                $.ajax({
                    url: '{% url 'reports:save_comment_for_report' %}',
                    data: data,
                    type: 'POST',
                    success: function(response) {
                        if (typeof response['complete'] != 'undefined' && response['complete'] == 1) {
                            new PNotify({
                                title: 'Ура!',
                                text: 'Комментарий успешно добавлен',
                                type: 'success',
                                styling: 'bootstrap3'
                            });
                        } else {
                            new PNotify({
                                title: 'О нет!',
                                text: 'Произошла ошибка при добавлении комментария.',
                                type: 'error',
                                styling: 'bootstrap3'
                            });
                        }
                        $('.ui-pnotify').fadeIn('slow');
                        setTimeout(function () {
                            $('.ui-pnotify').fadeOut('fast');
                        }, 2000);
                    }
                });
            });

            $('.save-report-button').on('click', function(e) {
                e.preventDefault();
                var href = $(this).attr('href');
                var id = $(this).data('report-id');
                var data = {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    start_time: $('.start-time-' + id).val(),
                    end_time: $('.end-time-' + id).val(),
                    shots_count: $('.shots-count-' + id).val(),
                    sum_for_bar: $('.sum-for-bar-' + id).val(),
                    discount: $('.discount-' + id).val()
                };
                $.ajax({
                    url: href,
                    data: data,
                    type: 'POST',
                    success: function(response) {
                        if (typeof response['complete'] != 'undefined' && response['complete'] == 1) {
                            new PNotify({
                                title: 'Ура!',
                                text: 'Отчет успешно обновлен.',
                                type: 'success',
                                styling: 'bootstrap3'
                            });
                            $('.ui-pnotify').fadeIn('slow');
                            setTimeout(function () {
                                location = '{% url 'reports:reports_by_week' %}' + window.location.search;
                            }, 1000);
                        } else {
                            new PNotify({
                                title: 'О нет!',
                                text: 'Произошла ошибка при обновлении отчета.',
                                type: 'error',
                                styling: 'bootstrap3'
                            });
                            $('.ui-pnotify').fadeIn('slow');
                            setTimeout(function () {
                                $('.ui-pnotify').fadeOut('fast');
                            }, 2000);
                        }
                    }
                });
            });

            // нажатие на кнопку добавления напитка к отчету
            $('.add-more-drink').on('click', function(e) {
                e.preventDefault();
                var report_id = $(this).data('report-id');
                var report_link = $(this).data('report-link');
                $.ajax({
                    url: report_link,
                    type: 'GET',
                    success: function (response) {
                        if (response['complete'] != '0' && response['complete'] != '') {
                            $('#drinks_' + report_id + ' tbody').append(response['complete']);
                        }
                    }
                });
            });
            // подгрузка напитков при открытии окна с напитками
            $('.open_drinks').on('click', function(e) {
                e.preventDefault();
                var report_id = $(this).data('report-id');
                var report_link = $(this).data('report-link');
                console.log(report_link);
                $.ajax({
                    url: report_link,
                    type: 'GET',
                    success: function (response) {
                        console.log(response);
                        if (response['complete'] != '0' && response['complete'] != '') {
                            $('#drinks_' + report_id + ' tbody').html(response['complete']);
                        }
                    }
                });
            });

            // нажатие на кнопку "Сохранить" в напитках
            $('.close_drinks_save').on('click', function(e) {
                e.preventDefault();
                var report_link = $(this).data('report-link');
                var report_id = $(this).data('report-id');
                var drinks = [];
                $('#drinks_' + report_id + ' .drink-line').each(function() {
                    drinks.push({id: $(this).find('.drink-line-id').val(), count: $(this).find('.drink-line-count').val()});
                });
                drinks = JSON.stringify(drinks);
                $.ajax({
                    url: report_link,
                    data: {'drinks[]': drinks, csrfmiddlewaretoken: '{{ csrf_token }}'},
                    type: 'POST',
                    success: function(response) {
                        if (typeof response['complete'] != 'undefined' && response['complete'] == 1) {
                            new PNotify({
                                title: 'Ура!',
                                text: 'Напитки успешно добавлены.',
                                type: 'success',
                                styling: 'bootstrap3'
                            });
                        } else {
                            new PNotify({
                                title: 'О нет!',
                                text: 'Произошла ошибка при сохранении напитков.',
                                type: 'error',
                                styling: 'bootstrap3'
                            });
                        }
                        $('.ui-pnotify').fadeIn('slow');
                        setTimeout(function () {
                            $('.ui-pnotify').fadeOut('fast');
                        }, 2000);
                    }
                });
            });

            // нажатие на кнопку удаления напитка
            $('.modal-body').on('click', '.drink-remove-line', function() {
                var line = $(this).closest('.drink-line');
                line.remove();
            });

            // смена фильтра
            $('.filters select').on('change', function(e) {
                e.preventDefault();
                getNewContent();
            })
        });

    </script>
{% endblock %}

{% block content %}
    <div class="col-md-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Отчеты
                    <small>{{ start_week }} - {{ end_week }}</small>
                </h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li class="pull-right"><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <a href="?week={{ prev_week }}&start_date={{ start_date }}">
                    <button class="btn"><i class="fa fa-long-arrow-left"></i> Предыдущая неделя</button>
                </a>
                <a href="?week={{ next_week }}&start_date={{ start_date }}">
                    <button class="btn">Следующая неделя <i class="fa fa-long-arrow-right"></i></button>
                </a>
                <div class="small-margin-top">
                    <button class="btn btn-primary" id="calendar">Выбрать неделю по дате</button>
                </div>
                {% if perms.extuser.can_edit_users %}
                    <div class="filters">
                        <table>
                            <tr>
                                <th>
                                    <div>Заведение</div>
                                    <div class="col-md-12 row">
                                      <select class="form-control" id="filter-club">
                                            <option value=""></option>
                                            {% for club in clubs %}
                                                <option value="{{ club.id }}">
                                                    {{ club.name }} {% if club.metro %}(м.{{ club.metro.name }}){% endif %}
                                                </option>
                                            {% endfor %}
                                      </select>
                                    </div>
                                </th>
                                <th>
                                    <div>Сотрудник</div>
                                    <div class="col-md-12 row">
                                      <select class="form-control" id="filter-employee">
                                            <option value=""></option>
                                            {% for employee in employees %}
                                                <option value="{{ employee.id }}">{{ employee.get_full_name }}</option>
                                            {% endfor %}
                                      </select>
                                    </div>
                                </th>
                                <th>
                                    <div>Тип</div>
                                    <div class="col-md-12 row">
                                      <select class="form-control" id="filter-type">
                                            <option value="-1">Все</option>
                                            <option value="0">Заполненные</option>
                                            <option value="1">Не заполненные</option>
                                      </select>
                                    </div>
                                </th>
                            </tr>
                        </table>
                    </div>
                {% endif %}
                <div id="reports-container">
                    {% include 'reports/_reports_list.html' %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}